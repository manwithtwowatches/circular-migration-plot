!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.CircularMigrationPlot=t()}}(function(){return function t(e,n,r){function a(o,u){if(!n[o]){if(!e[o]){var l="function"==typeof require&&require;if(!u&&l)return l(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var s=n[o]={exports:{}};e[o][0].call(s.exports,function(t){var n=e[o][1][t];return a(n?n:t)},s,s.exports,t,e,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)a(r[o]);return a}({1:[function(t,e){var n=t("./lib/chart"),r=t("./lib/timeline");e.exports=function(t){if(!t.data&&!t.data_set)throw"I need a data url or a data set!";if(!t.svg_element&&!t.chart)throw"I need a chart node or an SVG element!";if("string"==typeof t.chart&&(t.chart={element:t.chart}),t&&(t.chart=t),"string"==typeof t.timeline&&(t.timeline={element:t.timeline}),t.data_set){var e={matrix:t.data_set.matrix,names:t.data_set.names,regions:t.data_set.regions},a=n(e,t.chart);return r(a,t.timeline),a.draw(),a}d3.json(t.data,function(e){var a=n(e,t.chart);r(a,t.timeline),a.draw()})}},{"./lib/chart":2,"./lib/timeline":6}],2:[function(t,e){var n=t("./layout"),r=t("./chord"),a=Math.PI;e.exports=function(t,e){function o(t){if(t.region===t.id)return P(t.region);var e=d3.hsl(P(t.region)),n=[e.brighter(.75),e.darker(2),e,e.brighter(1.5),e.darker(1)];return n[(t.id-t.region)%5]}function u(t){return o(t.source)}function l(t){return{x:Math.cos(t-a/2)*e.labelRadius,y:Math.sin(t-a/2)*e.labelRadius,r:180*(t-a/2)/a}}function s(t,e){e=e||",",t+="",x=t.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var n=/(\d+)(\d{3})/;n.test(x1);)x1=x1.replace(n,"$1"+e+"$2");return x1+x2}function d(t){var e=d3.rgb(t);return.21*e.r+.71*e.g+.07*e.b}function c(n){var r=this;q&&clearTimeout(q);var a=r.getBBox();q=setTimeout(function(){var e=d3.select(r).style("fill");G.attr("transform","translate("+(a.x+a.width/2)+","+(a.y+a.height/2)+")");var i=G.select(".text").selectAll("text").data([t.names[n.id],"Total In: "+s(n.inflow),"Total Out: "+s(n.outflow)]);i.enter().append("text"),i.text(function(t){return t}).style({fill:d(e)>160?"black":"white"}).attr({transform:function(t,e){return"translate(6, "+(14*e+16)+")"}}),i.exit().remove();var o=G.select(".text").node().getBBox();G.select("rect").style("fill",e).attr({width:o.width+12,height:o.height+10}),G.transition().attr("opacity",1)},e.infoPopupDelay)}function g(t,e){B.selectAll(".label").classed("highlight",function(e){return e.index==t.source.index}),f.call(this,t,e)}function f(n){var r=this;q&&clearTimeout(q);var a=r.getBBox();q=setTimeout(function(){var e=d3.select(r).style("fill");G.attr("transform","translate("+(a.x+a.width/2)+","+(a.y+a.height/2)+")").attr("opacity",0).transition().attr("opacity",1);var i=G.select(".text").selectAll("text").data([t.names[n.source.id]+" â†’ "+t.names[n.target.id]+": "+s(n.source.value)]);i.enter().append("text"),i.exit().remove(),i.text(function(t){return t}).style({fill:d(e)>160?"black":"white"}).attr("transform",function(t,e){return"translate(6, "+(12*e+16)+")"}),G.selectAll("rect").style("fill",d3.select(r).style("fill"));var o=G.select(".text").node().getBBox();G.select("rect").attr({width:o.width+12,height:o.height+10})},e.infoPopupDelay)}function h(){R.groups=O.groups().reduce(function(t,e){return t[e.id]=e,t},{})}function p(){R.chords=O.chords().reduce(function(t,e){return t[e.source.id]=t[e.source.id]||{},t[e.source.id][e.target.id]=e,t},{})}function m(e){var n=t.regions[t.regions.indexOf(e)+1];return{start:e+1,end:n?n-1:t.names.length-1}}function v(t,e){return t>=e.start&&t<=e.end}function A(t,e){return!!e.filter(function(e){return v(t.source.id,e)||v(t.target.id,e)}).length}function y(t){if(t.id===t.region){var e=m(t.id),n=R.groups[e.start],r=R.groups[e.end];if(n&&r)return{angle:n.startAngle+(r.endAngle-n.startAngle)/2,startAngle:n.startAngle,endAngle:r.endAngle}}}function b(t){if(t.source.id===t.source.region){var e={source:{},target:{}};return Object.keys(R.chords).forEach(function(n){Object.keys(R.chords[n]).forEach(function(r){var a=R.chords[n][r];a.source.region===t.source.id&&((!e.source.startAngle||a.source.startAngle<e.source.startAngle)&&(e.source.startAngle=a.source.startAngle),(!e.source.endAngle||a.source.endAngle>e.source.endAngle)&&(e.source.endAngle=a.source.endAngle)),a.target.region===t.target.id&&((!e.target.startAngle||a.target.startAngle<e.target.startAngle)&&(e.target.startAngle=a.target.startAngle),(!e.target.endAngle||a.target.endAngle>e.target.endAngle)&&(e.target.endAngle=a.target.endAngle))})}),e.source.startAngle=e.source.startAngle||0,e.source.endAngle=e.source.endAngle||M,e.target.startAngle=e.target.startAngle||0,e.target.endAngle=e.target.endAngle||M,e.source.endAngle=e.source.startAngle+M,e.target.endAngle=e.target.startAngle+M,e}}function w(n,r){n=n||Object.keys(t.matrix)[0],r=r||R.countries,R.countries=r;var a=r.map(m);h(),p(),O.year(n).countries(r);var s=B.selectAll(".group").data(O.groups,function(t){return t.id});s.enter().append("g").attr("class","group"),s.on("mouseover",function(t){f.classed("highlight",function(t){return t.index==i}),C.classed("fade",function(e){return e.source.id!==t.id&&e.target.id!==t.id})}),s.exit().remove();var d=s.selectAll(".group-arc").data(function(t){return[t]});d.enter().append("path").attr("class","group-arc").attr("id",function(t,e,n){return"group"+n}),d.style("fill",o).on("mousemove",c).transition().duration(e.animationDuration).attrTween("d",function(t){var n=d3.interpolate(R.groups[t.id]||R.groups[t.region]||y(t)||e.initialAngle.arc,t);return function(t){return I(n(t))}}),d.exit().remove(),d.filter(function(t){return t.id===t.region}).on("click",function(t){r.length+1>e.maxRegionsOpen&&r.shift(),w(n,r.concat(t.id))}),d.filter(function(t){return t.id!==t.region}).on("click",function(t){r.splice(r.indexOf(t.region),1),w(n,r)});var f=B.selectAll(".label").data(O.groups,function(t){return t.id});f.enter().append("g").attr("class","label"),f.filter(function(t){return t.id!==t.region}).transition().duration(e.animationDuration).attrTween("transform",function(t){var e=d3.interpolate(R.groups[t.id]||R.groups[t.region]||y(t)||{angle:0},t);return function(t){var t=l(e(t).angle);return"translate("+t.x+" "+t.y+") rotate("+t.r+")"}}),f.exit().transition().duration(e.animationDuration).style("opacity",0).attrTween("transform",function(t){if(t.id!==t.region){var e=O.groups().filter(function(e){return e.id===t.region});e=e&&e[0];var n=e&&e.startAngle+(e.endAngle-e.startAngle)/2;n=n||0;var r=d3.interpolate(t,{angle:n});return function(t){var t=l(r(t).angle);return"translate("+t.x+" "+t.y+") rotate("+t.r+")"}}}).each("end",function(){d3.select(this).remove()});var x=f.selectAll("text").data(function(t){return[t]});x.enter().append("text"),x.classed("region",function(t){return t.id===t.region}).text(function(e){return e.id!==e.region?t.names[e.id]:void 0}).attr("transform",function(t){return t.id!==t.region?t.angle>Math.PI?"translate(0, -4) rotate(180)":"translate(0, 4)":void 0}).attr("text-anchor",function(t){return t.id===t.region?"middle":t.angle>Math.PI?"end":"start"}).style("fill",function(t){return t.id===t.region?o(t):null}).classed("fade",function(t){return t.value<e.mylayout.labelThreshold});var v=s.filter(function(t){return t.id===t.region}).selectAll(".group-textpath-arc").data(function(t){return[t]});v.enter().append("path").attr("class","group-textpath-arc").attr("id",function(t){return"group-textpath-arc"+t.id}),v.style("fill","none").transition().duration(e.animationDuration).attrTween("d",function(t){var n=d3.interpolate(R.groups[t.id]||R.groups[t.region]||y(t)||e.initialAngle.arc,t);return t.angle>Math.PI/2&&t.angle<3*Math.PI/2?function(t){return T(n(t))}:function(t){return k(n(t))}}),v.exit().remove();var P=x.filter(function(t){return t.id===t.region}).selectAll("textPath").data(function(t){return[t]});P.enter().append("textPath"),P.text(function(e){return t.names[e.id]}).attr("startOffset",function(t){return t.angle>Math.PI/2&&t.angle<3*Math.PI/2?"75%":"25%"}).attr("xlink:href",function(t){return"#group-textpath-arc"+t.id}),P.filter(function(t){return this.getComputedTextLength()>(t.endAngle-t.startAngle)*(e.outerRadius+18)}).remove();var C=B.selectAll(".chord").data(O.chords,function(t){return t.id});C.enter().append("path").attr("class","chord").on("mousemove",g),C.style("fill",u).transition().duration(e.animationDuration).attrTween("d",function(t){var n=R.chords[t.source.id]&&R.chords[t.source.id][t.target.id];n=n||R.chords[t.source.region]&&R.chords[t.source.region][t.target.region],n=n||b(t),n=n||e.initialAngle.chord;var r=d3.interpolate(n,t);return function(t){return D(r(t))}}),C.exit().transition().duration(e.animationDuration).style("opacity",0).attrTween("d",function(t){var e=d3.interpolate(t,{source:{startAngle:t.source.endAngle-M,endAngle:t.source.endAngle},target:{startAngle:t.target.endAngle-M,endAngle:t.target.endAngle}});return function(t){return D(e(t))}}).each("end",function(){d3.select(this).remove()}),C.classed("unselected",a.length?function(t){return!A(t,a)}:!1),d3.select(window).on("resize.svg-resize")()}t=t||{regions:[],names:[],matrix:[]},e=e||{},e.element=e.element||"body",e.now=e.now||Object.keys(t.matrix)[0],e.width=e.width||1100,e.height=e.height||1100,e.margin=e.margin||125,e.outerRadius=e.outerRadius||Math.min(e.width,e.height)/2-e.margin,e.arcWidth=e.arcWidth||24,e.innerRadius=e.innerRadius||e.outerRadius-e.arcWidth,e.arcPadding=e.arcPadding||.005,e.sourcePadding=e.sourcePadding||3,e.targetPadding=e.targetPadding||20,e.labelPadding=e.labelPadding||10,e.labelRadius=e.labelRadius||e.outerRadius+e.labelPadding;var M=Math.PI/1e5;e.animationDuration=e.animationDuration||1e3,e.initialAngle=e.initialAngle||{},e.initialAngle.arc=e.initialAngle.arc||{startAngle:0,endAngle:M},e.initialAngle.chord=e.initialAngle.chord||{source:e.initialAngle.arc,target:e.initialAngle.arc},e.mylayout=e.mylayout||{},e.mylayout.sortSubgroups=e.mylayout.sortSubgroups||d3.descending,e.mylayout.sortChords=e.mylayout.sortChords||d3.descending,e.mylayout.threshold=e.mylayout.threshold||1e3,e.mylayout.labelThreshold=e.mylayout.labelThreshold||1e5,e.maxRegionsOpen=e.maxRegionsOpen||2,e.infoPopupDelay=e.infoPopupDelay||300;var P=d3.scale.category10().domain(t.regions);e.mylayout.colors&&P.range(e.mylayout.colors);var R={countries:[]},k=d3.svg.arc().innerRadius(e.outerRadius+10).outerRadius(e.outerRadius+10),T=d3.svg.arc().innerRadius(e.outerRadius+18).outerRadius(e.outerRadius+18),I=d3.svg.arc().innerRadius(e.innerRadius).outerRadius(e.outerRadius),O=n().padding(e.arcPadding).threshold(e.mylayout.threshold).data(t).year(e.now);e.mylayout.sortGroups&&O.sortGroups(e.mylayout.sortGroups),e.mylayout.sortSubgroups&&O.sortSubgroups(e.mylayout.sortSubgroups),e.mylayout.sortChors&&O.sortChors(e.mylayout.sortChords);var D=r().radius(e.innerRadius).sourcePadding(e.sourcePadding).targetPadding(e.targetPadding),C=e.svg_element||d3.select(e.element).append("svg").attr("preserveAspectRatio","xMidYMid").attr("viewBox","0 0 "+e.width+" "+e.height).attr("width",e.width).attr("height",e.height),B=C.append("g").attr("id","circle").attr("transform","translate("+e.width/2+","+e.height/2+")");d3.select(window).on("resize.svg-resize",function(){var t=C.node().parentNode.clientWidth;t&&C.attr("height",t)});var S=B.append("circle").attr("r",e.outerRadius+24).style({fill:"none"}),j=C.append("filter").attr("id","dropshadow");j.append("feGaussianBlur").attr({"in":"SourceAlpha",stdDeviation:2}),j.append("feOffset").attr({dx:0,dy:1,result:"offsetblur"}),j.append("feComponentTransfer").append("feFuncA").attr({type:"linear",slope:.5});var _=j.append("feMerge");_.append("feMergeNode"),_.append("feMergeNode").attr("in","SourceGraphic");var G=C.append("g").attr("class","info-group").attr("transform","translate("+e.width/2+","+e.height/2+")").append("g").attr("class","info").attr("opacity",0);G.append("rect").style("filter","url(#dropshadow)"),G.append("g").attr("class","text"),C.on("mousemove",function(){G.transition().duration(10).attr("opacity",0)}),S.on("mouseout",function(){q&&clearTimeout(q),G.transition().duration(10).attr("opacity",0)});var q;return{draw:w,data:t,element:B}}},{"./chord":3,"./layout":5}],3:[function(t,e){function n(t){return t.source}function r(t){return t.target}function a(t){return t.startAngle}function i(t){return t.endAngle}function o(t){return t.radius}function u(t){return t.targetPadding}function l(t){return t.sourcePadding}var s=d3.functor,d=Math.PI,c=-d/2;e.exports=function(){function t(t,n){var r=g(this,m,t,n),a=g(this,x,t,n,!0);f(r,a)&&(r.a1=r.a1-(r.a1-r.a0)/2,r.p1=[r.r*Math.cos(r.a1),r.r*Math.sin(r.a1)],a.a0=a.a0+(a.a1-a.a0)/2,a.p0=[a.r*Math.cos(a.a0),a.r*Math.sin(a.a0)]);var i=e(r,a,.618*r.r);return"M"+r.p0+h(r.r,r.p1,r.a1-r.a0)+p(i.cps1,i.cpt0,a.p0)+h(a.r,a.p1,a.a1-a.a0)+p(i.cpt1,i.cps0,r.p0)+"Z"}function e(t,e,n){return cps0=[n*Math.cos(t.a0),n*Math.sin(t.a0)],cps1=[n*Math.cos(t.a1),n*Math.sin(t.a1)],cpt0=[n*Math.cos(e.a0),n*Math.sin(e.a0)],cpt1=[n*Math.cos(e.a1),n*Math.sin(e.a1)],{cps0:cps0,cps1:cps1,cpt0:cpt0,cpt1:cpt1}}function g(t,e,n,r,a){var i=e.call(t,n,r),o=v.call(t,i,r),u=b.call(t,i,r)+c,l=w.call(t,i,r)+c;if(a){var n=y.call(t,i,r)||0;o-=n}else{var n=A.call(t,i,r)||0;o-=n}return{r:o,a0:u,a1:l,p0:[o*Math.cos(u),o*Math.sin(u)],p1:[o*Math.cos(l),o*Math.sin(l)]}}function f(t,e){return t.a0==e.a0&&t.a1==e.a1}function h(t,e,n){return"A"+t+","+t+" 0 "+ +(n>d)+",1 "+e}function p(t,e,n){return"C "+t+" "+e+" "+n}var m=n,x=r,v=o,A=l,y=u,b=a,w=i;return t.radius=function(e){return arguments.length?(v=s(e),t):v},t.sourcePadding=function(e){return arguments.length?(A=s(e),t):A},t.targetPadding=function(e){return arguments.length?(y=s(e),t):y},t.source=function(e){return arguments.length?(m=s(e),t):m},t.target=function(e){return arguments.length?(x=s(e),t):x},t.startAngle=function(e){return arguments.length?(b=s(e),t):b},t.endAngle=function(e){return arguments.length?(w=s(e),t):w},t}},{}],4:[function(t,e){e.exports=function(t,e){return t.regions.reduce(function(n,r,a){if(-1===e.indexOf(r))n.push(r);else for(var i=r+1;i<(t.regions[a+1]||t.names.length);i++)n.push(i);return n},[])}},{}],5:[function(t,e){var n=t("./countrymerge"),r=Math.PI;e.exports=function(){function t(t){for(var e=0,n=0;n<u.regions.length&&!(u.regions[n]>t);n++)e=n;return u.regions[e]}function e(){var e,n,d,m,A,y={},b=[],w=d3.range(g),M=[];for(u=u||{matrix:{},names:[],regions:[]},c=c||Object.keys(u.matrix)[0],l=c&&u.matrix[c]||[],i=[],o=[],e=0,m=-1;++m<g;){for(n=0,A=-1;++A<g;)n+=l[s[m]][s[A]],n+=l[s[A]][s[m]];b.push(n),M.push({source:d3.range(g),target:d3.range(g)}),e+=n}for(f&&w.sort(function(t,e){return f(b[t],b[e])}),h&&M.forEach(function(t,e){t.source.sort(function(t,n){return h(l[s[e]][s[t]],l[s[e]][s[n]])}),t.target.sort(function(t,n){return h(l[s[t]][s[e]],l[s[n]][s[e]])})}),e=(2*r-x*g)/e,n=0,m=-1;++m<g;){var P=0,R=0,k=w[m];for(d=n,A=-1;++A<g;){var T=M[k].target[A],I=l[s[T]][s[k]],O=n,D=I*e;n+=D,y["target-"+k+"-"+T]={originalIndex:s[T],index:k,subindex:T,startAngle:O,dAngle:I*e,value:I},P+=I}var C=d;for(d=n,A=-1;++A<g;){var T=M[k].source[A],I=l[s[k]][s[T]],O=n,D=I*e;n+=D,y["source-"+k+"-"+T]={originalIndex:s[k],index:k,subindex:T,startAngle:O,dAngle:I*e,value:I},R+=I}o[k]={id:s[k],region:t(s[k]),index:k,startAngle:C,endAngle:n,angle:C+(n-C)/2,inflow:P,outflow:R,value:Math.round((n-C)/e)},n+=x}for(m=-1;++m<g;)for(A=m-1;++A<g;){var B=y["source-"+m+"-"+A],S=y["target-"+A+"-"+m];if(m===A){if(null===v||B.value>=v){var S=y["target-"+m+"-"+A];i.push({id:"source-"+s[m]+"-"+s[A],source:{id:s[B.index],region:t(s[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:s[S.index],region:t(s[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}})}}else{(null===v||B.value>=v)&&i.push({id:"source-"+s[m]+"-"+s[A],source:{id:s[B.index],region:t(s[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:s[S.index],region:t(s[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}});var B=y["source-"+A+"-"+m],S=y["target-"+m+"-"+A];(null===v||B.value>=v)&&i.push({id:"target-"+s[m]+"-"+s[A],source:{id:s[B.index],region:t(s[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:s[S.index],region:t(s[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}})}}p&&a()}function a(){i.sort(function(t,e){return p(t.source.value,e.source.value)})}var i,o,u,l,s,d,c,g,f,h,p,m={},x=0,v=null;return m.data=function(t){return arguments.length?(u=t,s=u.regions.slice(),g=s.length,i=o=null,m):u},m.year=function(t){return arguments.length?(c=t,i=o=null,m):c},m.countries=function(t){return arguments.length?(d=t,s=n(u,d),g=s.length,i=o=null,m):d},m.padding=function(t){return arguments.length?(x=t,i=o=null,m):x},m.threshold=function(t){return arguments.length?(v=t,i=o=null,m):v},m.sortGroups=function(t){return arguments.length?(f=t,i=o=null,m):f},m.sortSubgroups=function(t){return arguments.length?(h=t,i=null,m):h},m.sortChords=function(t){return arguments.length?(p=t,i&&a(),m):p},m.chords=function(){return i||e(),i},m.groups=function(){return o||e(),o},m}},{"./countrymerge":4}],6:[function(t,e){e.exports=function(t,e){var n=Object.keys(t.data.matrix).map(function(t){return parseInt(t)});if(e=e||{},e.element=e.element||"body",e.now=e.now||n[0],e.formatter=e.formatter||function(t){return t},e.no_timeline)return!1;var r=d3.select(e.element).append("form"),a=r.selectAll(".year").data(n),i=a.enter().append("span").classed("year",!0);i.append("input").attr({name:"year",type:"radio",id:function(t){return"year-"+t},value:function(t){return t},checked:function(t){return t===e.now||null}}).on("click",function(e){var n=e;a.selectAll("input").attr("checked",function(t){return n===t||null}),t.draw(e)}),i.append("label").attr("for",function(t){return"year-"+t}).text(e.formatter),d3.select(document.body).on("keypress",function(){var t=d3.event.which-49,e=n[t];e&&a.selectAll("input").each(function(t){t===e&&d3.select(this).on("click")(t)})})}},{}]},{},[1])(1)});