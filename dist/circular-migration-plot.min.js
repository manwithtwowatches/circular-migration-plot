!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.CircularMigrationPlot=t()}}(function(){return function t(e,n,r){function a(o,u){if(!n[o]){if(!e[o]){var s="function"==typeof require&&require;if(!u&&s)return s(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var l=n[o]={exports:{}};e[o][0].call(l.exports,function(t){var n=e[o][1][t];return a(n?n:t)},l,l.exports,t,e,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)a(r[o]);return a}({1:[function(t,e){var n=t("./lib/chart"),r=t("./lib/timeline");e.exports=function(t){if(!t.data&&!t.data_set)throw"I need a data url or a data set!";if(!t.svg_element&&!t.chart)throw"I need a chart node or an SVG element!";if("string"==typeof t.chart&&(t.chart={element:t.chart}),t&&(t.chart=t),"string"==typeof t.timeline&&(t.timeline={element:t.timeline}),t.data_set){var e={matrix:t.data_set.matrix,names:t.data_set.names,regions:t.data_set.regions},a=n(e,t.chart);return r(a,t.timeline),a.draw(),a}d3.json(t.data,function(e){var a=n(e,t.chart);r(a,t.timeline),a.draw()})}},{"./lib/chart":2,"./lib/timeline":6}],2:[function(t,e){var n=t("./layout"),r=t("./chord"),a=Math.PI;e.exports=function(t,e){function i(t){if(t.region===t.id)return w(t.region);var e=d3.hsl(w(t.region)),n=[e.brighter(.75),e.darker(2),e,e.brighter(1.5),e.darker(1)];return n[(t.id-t.region)%5]}function o(t){return i(t.source)}function u(t){return{x:Math.cos(t-a/2)*e.labelRadius,y:Math.sin(t-a/2)*e.labelRadius,r:180*(t-a/2)/a}}function s(t,e){e=e||",",t+="",x=t.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var n=/(\d+)(\d{3})/;n.test(x1);)x1=x1.replace(n,"$1"+e+"$2");return x1+x2}function l(t){var e=d3.rgb(t);return.21*e.r+.71*e.g+.07*e.b}function d(n){var r=this;G&&clearTimeout(G);var a=r.getBBox();G=setTimeout(function(){var e=d3.select(r).style("fill");j.attr("transform","translate("+(a.x+a.width/2)+","+(a.y+a.height/2)+")");var i=j.select(".text").selectAll("text").data([t.names[n.id],"Total In: "+s(n.inflow),"Total Out: "+s(n.outflow)]);i.enter().append("text"),i.text(function(t){return t}).style({fill:l(e)>160?"black":"white"}).attr({transform:function(t,e){return"translate(6, "+(14*e+16)+")"}}),i.exit().remove();var o=j.select(".text").node().getBBox();j.select("rect").style("fill",e).attr({width:o.width+12,height:o.height+10}),j.transition().attr("opacity",1)},e.infoPopupDelay)}function c(n){var r=this;G&&clearTimeout(G);var a=r.getBBox();G=setTimeout(function(){var e=d3.select(r).style("fill");j.attr("transform","translate("+(a.x+a.width/2)+","+(a.y+a.height/2)+")").attr("opacity",0).transition().attr("opacity",1);var i=j.select(".text").selectAll("text").data([t.names[n.source.id]+" â†’ "+t.names[n.target.id]+": "+s(n.source.value)]);i.enter().append("text"),i.exit().remove(),i.text(function(t){return t}).style({fill:l(e)>160?"black":"white"}).attr("transform",function(t,e){return"translate(6, "+(12*e+16)+")"}),j.selectAll("rect").style("fill",d3.select(r).style("fill"));var o=j.select(".text").node().getBBox();j.select("rect").attr({width:o.width+12,height:o.height+10})},e.infoPopupDelay)}function g(){M.groups=T.groups().reduce(function(t,e){return t[e.id]=e,t},{})}function f(){M.chords=T.chords().reduce(function(t,e){return t[e.source.id]=t[e.source.id]||{},t[e.source.id][e.target.id]=e,t},{})}function h(e){var n=t.regions[t.regions.indexOf(e)+1];return{start:e+1,end:n?n-1:t.names.length-1}}function p(t,e){return t>=e.start&&t<=e.end}function m(t,e){return!!e.filter(function(e){return p(t.source.id,e)||p(t.target.id,e)}).length}function v(t){if(t.id===t.region){var e=h(t.id),n=M.groups[e.start],r=M.groups[e.end];if(n&&r)return{angle:n.startAngle+(r.endAngle-n.startAngle)/2,startAngle:n.startAngle,endAngle:r.endAngle}}}function A(t){if(t.source.id===t.source.region){var e={source:{},target:{}};return Object.keys(M.chords).forEach(function(n){Object.keys(M.chords[n]).forEach(function(r){var a=M.chords[n][r];a.source.region===t.source.id&&((!e.source.startAngle||a.source.startAngle<e.source.startAngle)&&(e.source.startAngle=a.source.startAngle),(!e.source.endAngle||a.source.endAngle>e.source.endAngle)&&(e.source.endAngle=a.source.endAngle)),a.target.region===t.target.id&&((!e.target.startAngle||a.target.startAngle<e.target.startAngle)&&(e.target.startAngle=a.target.startAngle),(!e.target.endAngle||a.target.endAngle>e.target.endAngle)&&(e.target.endAngle=a.target.endAngle))})}),e.source.startAngle=e.source.startAngle||0,e.source.endAngle=e.source.endAngle||b,e.target.startAngle=e.target.startAngle||0,e.target.endAngle=e.target.endAngle||b,e.source.endAngle=e.source.startAngle+b,e.target.endAngle=e.target.startAngle+b,e}}function y(n,r){n=n||Object.keys(t.matrix)[0],r=r||M.countries,M.countries=r;var a=r.map(h);g(),f(),T.year(n).countries(r);var s=D.selectAll(".group").data(T.groups,function(t){return t.id});s.enter().append("g").attr("class","group"),s.on("mouseover",function(t){C.classed("fade",function(e){return e.source.id!==t.id&&e.target.id!==t.id})}),s.exit().remove();var l=s.selectAll(".group-arc").data(function(t){return[t]});l.enter().append("path").attr("class","group-arc").attr("id",function(t,e,n){return"group"+n}),l.style("fill",i).on("mousemove",d).transition().duration(e.animationDuration).attrTween("d",function(t){var n=d3.interpolate(M.groups[t.id]||M.groups[t.region]||v(t)||e.initialAngle.arc,t);return function(t){return k(n(t))}}),l.exit().remove(),l.filter(function(t){return t.id===t.region}).on("click",function(t){r.length+1>e.maxRegionsOpen&&r.shift(),y(n,r.concat(t.id))}),l.filter(function(t){return t.id!==t.region}).on("click",function(t){r.splice(r.indexOf(t.region),1),y(n,r)});var p=D.selectAll(".label").data(T.groups,function(t){return t.id});p.enter().append("g").attr("class","label"),p.filter(function(t){return t.id!==t.region}).transition().duration(e.animationDuration).attrTween("transform",function(t){var e=d3.interpolate(M.groups[t.id]||M.groups[t.region]||v(t)||{angle:0},t);return function(t){var t=u(e(t).angle);return"translate("+t.x+" "+t.y+") rotate("+t.r+")"}}),p.exit().transition().duration(e.animationDuration).style("opacity",0).attrTween("transform",function(t){if(t.id!==t.region){var e=T.groups().filter(function(e){return e.id===t.region});e=e&&e[0];var n=e&&e.startAngle+(e.endAngle-e.startAngle)/2;n=n||0;var r=d3.interpolate(t,{angle:n});return function(t){var t=u(r(t).angle);return"translate("+t.x+" "+t.y+") rotate("+t.r+")"}}}).each("end",function(){d3.select(this).remove()});var x=p.selectAll("text").data(function(t){return[t]});x.enter().append("text"),x.classed("region",function(t){return t.id===t.region}).text(function(e){return e.id!==e.region?t.names[e.id]:void 0}).attr("transform",function(t){return t.id!==t.region?t.angle>Math.PI?"translate(0, -4) rotate(180)":"translate(0, 4)":void 0}).attr("text-anchor",function(t){return t.id===t.region?"middle":t.angle>Math.PI?"end":"start"}).style("fill",function(t){return t.id===t.region?i(t):null}).classed("fade",function(t){return t.value<e.mylayout.labelThreshold});var w=s.filter(function(t){return t.id===t.region}).selectAll(".group-textpath-arc").data(function(t){return[t]});w.enter().append("path").attr("class","group-textpath-arc").attr("id",function(t){return"group-textpath-arc"+t.id}),w.style("fill","none").transition().duration(e.animationDuration).attrTween("d",function(t){var n=d3.interpolate(M.groups[t.id]||M.groups[t.region]||v(t)||e.initialAngle.arc,t);return t.angle>Math.PI/2&&t.angle<3*Math.PI/2?function(t){return R(n(t))}:function(t){return P(n(t))}}),w.exit().remove();var O=x.filter(function(t){return t.id===t.region}).selectAll("textPath").data(function(t){return[t]});O.enter().append("textPath"),O.text(function(e){return t.names[e.id]}).attr("startOffset",function(t){return t.angle>Math.PI/2&&t.angle<3*Math.PI/2?"75%":"25%"}).attr("xlink:href",function(t){return"#group-textpath-arc"+t.id}),O.filter(function(t){return this.getComputedTextLength()>(t.endAngle-t.startAngle)*(e.outerRadius+18)}).remove();var C=D.selectAll(".chord").data(T.chords,function(t){return t.id});C.enter().append("path").attr("class","chord").on("mousemove",c),C.style("fill",o).transition().duration(e.animationDuration).attrTween("d",function(t){var n=M.chords[t.source.id]&&M.chords[t.source.id][t.target.id];n=n||M.chords[t.source.region]&&M.chords[t.source.region][t.target.region],n=n||A(t),n=n||e.initialAngle.chord;var r=d3.interpolate(n,t);return function(t){return I(r(t))}}),C.exit().transition().duration(e.animationDuration).style("opacity",0).attrTween("d",function(t){var e=d3.interpolate(t,{source:{startAngle:t.source.endAngle-b,endAngle:t.source.endAngle},target:{startAngle:t.target.endAngle-b,endAngle:t.target.endAngle}});return function(t){return I(e(t))}}).each("end",function(){d3.select(this).remove()}),C.classed("unselected",a.length?function(t){return!m(t,a)}:!1),d3.select(window).on("resize.svg-resize")()}t=t||{regions:[],names:[],matrix:[]},e=e||{},e.element=e.element||"body",e.now=e.now||Object.keys(t.matrix)[0],e.width=e.width||1100,e.height=e.height||1100,e.margin=e.margin||125,e.outerRadius=e.outerRadius||Math.min(e.width,e.height)/2-e.margin,e.arcWidth=e.arcWidth||24,e.innerRadius=e.innerRadius||e.outerRadius-e.arcWidth,e.arcPadding=e.arcPadding||.005,e.sourcePadding=e.sourcePadding||3,e.targetPadding=e.targetPadding||20,e.labelPadding=e.labelPadding||10,e.labelRadius=e.labelRadius||e.outerRadius+e.labelPadding;var b=Math.PI/1e5;e.animationDuration=e.animationDuration||1e3,e.initialAngle=e.initialAngle||{},e.initialAngle.arc=e.initialAngle.arc||{startAngle:0,endAngle:b},e.initialAngle.chord=e.initialAngle.chord||{source:e.initialAngle.arc,target:e.initialAngle.arc},e.mylayout=e.mylayout||{},e.mylayout.sortSubgroups=e.mylayout.sortSubgroups||d3.descending,e.mylayout.sortChords=e.mylayout.sortChords||d3.descending,e.mylayout.threshold=e.mylayout.threshold||1e3,e.mylayout.labelThreshold=e.mylayout.labelThreshold||1e5,e.maxRegionsOpen=e.maxRegionsOpen||2,e.infoPopupDelay=e.infoPopupDelay||300;var w=d3.scale.category10().domain(t.regions);e.mylayout.colors&&w.range(e.mylayout.colors);var M={countries:[]},P=d3.svg.arc().innerRadius(e.outerRadius+10).outerRadius(e.outerRadius+10),R=d3.svg.arc().innerRadius(e.outerRadius+18).outerRadius(e.outerRadius+18),k=d3.svg.arc().innerRadius(e.innerRadius).outerRadius(e.outerRadius),T=n().padding(e.arcPadding).threshold(e.mylayout.threshold).data(t).year(e.now);e.mylayout.sortGroups&&T.sortGroups(e.mylayout.sortGroups),e.mylayout.sortSubgroups&&T.sortSubgroups(e.mylayout.sortSubgroups),e.mylayout.sortChors&&T.sortChors(e.mylayout.sortChords);var I=r().radius(e.innerRadius).sourcePadding(e.sourcePadding).targetPadding(e.targetPadding),O=e.svg_element||d3.select(e.element).append("svg").attr("preserveAspectRatio","xMidYMid").attr("viewBox","0 0 "+e.width+" "+e.height).attr("width",e.width).attr("height",e.height),D=O.append("g").attr("id","circle").attr("transform","translate("+e.width/2+","+e.height/2+")");d3.select(window).on("resize.svg-resize",function(){var t=O.node().parentNode.clientWidth;t&&O.attr("height",t)});var C=D.append("circle").attr("r",e.outerRadius+24),B=O.append("filter").attr("id","dropshadow");B.append("feGaussianBlur").attr({"in":"SourceAlpha",stdDeviation:2}),B.append("feOffset").attr({dx:0,dy:1,result:"offsetblur"}),B.append("feComponentTransfer").append("feFuncA").attr({type:"linear",slope:.5});var S=B.append("feMerge");S.append("feMergeNode"),S.append("feMergeNode").attr("in","SourceGraphic");var j=O.append("g").attr("class","info-group").attr("transform","translate("+e.width/2+","+e.height/2+")").append("g").attr("class","info").attr("opacity",0);j.append("rect").style("filter","url(#dropshadow)"),j.append("g").attr("class","text"),O.on("mousemove",function(){j.transition().duration(10).attr("opacity",0)}),C.on("mouseout",function(){G&&clearTimeout(G),j.transition().duration(10).attr("opacity",0)});var G;return{draw:y,data:t,element:D}}},{"./chord":3,"./layout":5}],3:[function(t,e){function n(t){return t.source}function r(t){return t.target}function a(t){return t.startAngle}function i(t){return t.endAngle}function o(t){return t.radius}function u(t){return t.targetPadding}function s(t){return t.sourcePadding}var l=d3.functor,d=Math.PI,c=-d/2;e.exports=function(){function t(t,n){var r=g(this,m,t,n),a=g(this,v,t,n,!0);f(r,a)&&(r.a1=r.a1-(r.a1-r.a0)/2,r.p1=[r.r*Math.cos(r.a1),r.r*Math.sin(r.a1)],a.a0=a.a0+(a.a1-a.a0)/2,a.p0=[a.r*Math.cos(a.a0),a.r*Math.sin(a.a0)]);var i=e(r,a,.618*r.r);return"M"+r.p0+h(r.r,r.p1,r.a1-r.a0)+p(i.cps1,i.cpt0,a.p0)+h(a.r,a.p1,a.a1-a.a0)+p(i.cpt1,i.cps0,r.p0)+"Z"}function e(t,e,n){return cps0=[n*Math.cos(t.a0),n*Math.sin(t.a0)],cps1=[n*Math.cos(t.a1),n*Math.sin(t.a1)],cpt0=[n*Math.cos(e.a0),n*Math.sin(e.a0)],cpt1=[n*Math.cos(e.a1),n*Math.sin(e.a1)],{cps0:cps0,cps1:cps1,cpt0:cpt0,cpt1:cpt1}}function g(t,e,n,r,a){var i=e.call(t,n,r),o=x.call(t,i,r),u=b.call(t,i,r)+c,s=w.call(t,i,r)+c;if(a){var n=y.call(t,i,r)||0;o-=n}else{var n=A.call(t,i,r)||0;o-=n}return{r:o,a0:u,a1:s,p0:[o*Math.cos(u),o*Math.sin(u)],p1:[o*Math.cos(s),o*Math.sin(s)]}}function f(t,e){return t.a0==e.a0&&t.a1==e.a1}function h(t,e,n){return"A"+t+","+t+" 0 "+ +(n>d)+",1 "+e}function p(t,e,n){return"C "+t+" "+e+" "+n}var m=n,v=r,x=o,A=s,y=u,b=a,w=i;return t.radius=function(e){return arguments.length?(x=l(e),t):x},t.sourcePadding=function(e){return arguments.length?(A=l(e),t):A},t.targetPadding=function(e){return arguments.length?(y=l(e),t):y},t.source=function(e){return arguments.length?(m=l(e),t):m},t.target=function(e){return arguments.length?(v=l(e),t):v},t.startAngle=function(e){return arguments.length?(b=l(e),t):b},t.endAngle=function(e){return arguments.length?(w=l(e),t):w},t}},{}],4:[function(t,e){e.exports=function(t,e){return t.regions.reduce(function(n,r,a){if(-1===e.indexOf(r))n.push(r);else for(var i=r+1;i<(t.regions[a+1]||t.names.length);i++)n.push(i);return n},[])}},{}],5:[function(t,e){var n=t("./countrymerge"),r=Math.PI;e.exports=function(){function t(t){for(var e=0,n=0;n<u.regions.length&&!(u.regions[n]>t);n++)e=n;return u.regions[e]}function e(){var e,n,d,m,A,y={},b=[],w=d3.range(g),M=[];for(u=u||{matrix:{},names:[],regions:[]},c=c||Object.keys(u.matrix)[0],s=c&&u.matrix[c]||[],i=[],o=[],e=0,m=-1;++m<g;){for(n=0,A=-1;++A<g;)n+=s[l[m]][l[A]],n+=s[l[A]][l[m]];b.push(n),M.push({source:d3.range(g),target:d3.range(g)}),e+=n}for(f&&w.sort(function(t,e){return f(b[t],b[e])}),h&&M.forEach(function(t,e){t.source.sort(function(t,n){return h(s[l[e]][l[t]],s[l[e]][l[n]])}),t.target.sort(function(t,n){return h(s[l[t]][l[e]],s[l[n]][l[e]])})}),e=(2*r-v*g)/e,n=0,m=-1;++m<g;){var P=0,R=0,k=w[m];for(d=n,A=-1;++A<g;){var T=M[k].target[A],I=s[l[T]][l[k]],O=n,D=I*e;n+=D,y["target-"+k+"-"+T]={originalIndex:l[T],index:k,subindex:T,startAngle:O,dAngle:I*e,value:I},P+=I}var C=d;for(d=n,A=-1;++A<g;){var T=M[k].source[A],I=s[l[k]][l[T]],O=n,D=I*e;n+=D,y["source-"+k+"-"+T]={originalIndex:l[k],index:k,subindex:T,startAngle:O,dAngle:I*e,value:I},R+=I}o[k]={id:l[k],region:t(l[k]),index:k,startAngle:C,endAngle:n,angle:C+(n-C)/2,inflow:P,outflow:R,value:Math.round((n-C)/e)},n+=v}for(m=-1;++m<g;)for(A=m-1;++A<g;){var B=y["source-"+m+"-"+A],S=y["target-"+A+"-"+m];if(m===A){if(null===x||B.value>=x){var S=y["target-"+m+"-"+A];i.push({id:"source-"+l[m]+"-"+l[A],source:{id:l[B.index],region:t(l[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:l[S.index],region:t(l[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}})}}else{(null===x||B.value>=x)&&i.push({id:"source-"+l[m]+"-"+l[A],source:{id:l[B.index],region:t(l[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:l[S.index],region:t(l[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}});var B=y["source-"+A+"-"+m],S=y["target-"+m+"-"+A];(null===x||B.value>=x)&&i.push({id:"target-"+l[m]+"-"+l[A],source:{id:l[B.index],region:t(l[B.index]),index:B.index,subindex:B.subindex,startAngle:B.startAngle,endAngle:B.startAngle+B.dAngle,value:B.value},target:{id:l[S.index],region:t(l[S.index]),index:S.index,subindex:S.subindex,startAngle:S.startAngle,endAngle:S.startAngle+S.dAngle,value:S.value}})}}p&&a()}function a(){i.sort(function(t,e){return p(t.source.value,e.source.value)})}var i,o,u,s,l,d,c,g,f,h,p,m={},v=0,x=null;return m.data=function(t){return arguments.length?(u=t,l=u.regions.slice(),g=l.length,i=o=null,m):u},m.year=function(t){return arguments.length?(c=t,i=o=null,m):c},m.countries=function(t){return arguments.length?(d=t,l=n(u,d),g=l.length,i=o=null,m):d},m.padding=function(t){return arguments.length?(v=t,i=o=null,m):v},m.threshold=function(t){return arguments.length?(x=t,i=o=null,m):x},m.sortGroups=function(t){return arguments.length?(f=t,i=o=null,m):f},m.sortSubgroups=function(t){return arguments.length?(h=t,i=null,m):h},m.sortChords=function(t){return arguments.length?(p=t,i&&a(),m):p},m.chords=function(){return i||e(),i},m.groups=function(){return o||e(),o},m}},{"./countrymerge":4}],6:[function(t,e){e.exports=function(t,e){var n=Object.keys(t.data.matrix).map(function(t){return parseInt(t)});e=e||{},e.element=e.element||"body",e.now=e.now||n[0],e.formatter=e.formatter||function(t){return t};var r=d3.select(e.element).append("form"),a=r.selectAll(".year").data(n),i=a.enter().append("span").classed("year",!0);i.append("input").attr({name:"year",type:"radio",id:function(t){return"year-"+t},value:function(t){return t},checked:function(t){return t===e.now||null}}).on("click",function(e){var n=e;a.selectAll("input").attr("checked",function(t){return n===t||null}),t.draw(e)}),i.append("label").attr("for",function(t){return"year-"+t}).text(e.formatter),d3.select(document.body).on("keypress",function(){var t=d3.event.which-49,e=n[t];e&&a.selectAll("input").each(function(t){t===e&&d3.select(this).on("click")(t)})})}},{}]},{},[1])(1)});